<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local Password Vault ‚Äî Enhanced</title>
  <style>
    :root{
      /* Light */
      --bg-light:#f8fafc; --text-light:#0f172a; --panel-light:#ffffff; --muted-light:#475569; --border-light:#d1d5db;
      /* Dark */
      --bg-dark:#0f172a; --text-dark:#e5e7eb; --panel-dark:#111827; --muted-dark:#94a3b8; --border-dark:#1f2937;
      /* Brand */
      --ring:#3b82f6; --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --shadow:0 12px 30px rgba(0,0,0,.18);
    }
    /* Theme vars set in JS -> --bg, --text, --panel, --muted, --border */
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--text); transition:background .35s,color .35s}
    .wrap{max-width:1040px;margin:36px auto;padding:0 16px}
    .nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{display:flex;align-items:center;gap:10px}
    .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--ring),var(--accent));box-shadow:0 4px 14px rgba(34,197,94,.35)}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{appearance:none;width:46px;height:26px;border-radius:26px;background:var(--border);position:relative;outline:0;transition:.25s}
    .switch input::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:var(--text);transition:.25s}
    .switch input:checked{background:var(--accent)}
    .switch input:checked::after{transform:translateX(20px)}

    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); overflow:hidden}
    .pad{padding:18px}
    h1{font-size:24px;margin:0}
    p{color:var(--muted)}

    input, textarea, select {width:100%;background:transparent;border:1px solid var(--border);color:inherit;border-radius:10px;padding:10px 12px;outline:none}
    input:focus, textarea:focus, select:focus{border-color:var(--ring);box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    button{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(0,0,0,.06));color:inherit;padding:10px 14px;border-radius:10px;cursor:pointer;transition:transform .15s}
    button:hover{transform:translateY(-1px)}
    .btn{display:inline-flex;align-items:center;gap:8px}
    .btn.accent{background:linear-gradient(180deg,#22c55e,#16a34a); color:#05290f; border-color:#16a34a; font-weight:600}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#b45309); color:#1a0b00; border-color:#b45309}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#b91c1c); color:#1a0b00; border-color:#b91c1c}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:12px 0 8px}
    .toolbar .left,.toolbar .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .metrics{display:flex;gap:10px;flex-wrap:wrap}
    .badge{font-size:12px;border:1px solid var(--border);padding:4px 10px;border-radius:999px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width:800px){ .grid{grid-template-columns:1.2fr .8fr} }

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{font-weight:600;color:var(--muted);font-size:13px;text-align:left;padding:0 10px}
    td{background:var(--panel);border:1px solid var(--border);padding:10px;border-radius:10px}
    tr td:first-child{border-top-right-radius:0;border-bottom-right-radius:0}
    tr td:last-child{border-top-left-radius:0;border-bottom-left-radius:0}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .muted{color:var(--muted)}
    .right{text-align:right}

    .hint{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:linear-gradient(90deg,transparent,#2a364d,transparent);opacity:.5;margin:14px 0}
    .hidden{display:none}

    /* Toast */
    .toast{position:fixed;right:16px;bottom:16px;background:var(--panel);border:1px solid var(--border);padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);opacity:0;transform:translateY(6px);transition:opacity .25s, transform .25s}
    .toast.show{opacity:1;transform:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <div class="title"><div class="logo"></div><h1>Local Password Vault</h1></div>
      <label class="switch"><input id="themeToggle" type="checkbox"><span>üåû / üåú</span></label>
    </div>

    <!-- AUTH CARD -->
    <div id="authCard" class="card pad">
      <p>≈ûifr…ôl…ôriniz yalnƒ±z bu brauzerd…ô <strong>yerli</strong> saxlanƒ±lƒ±r v…ô <strong>AES‚ÄëGCM</strong> il…ô ≈üifr…ôl…ônir. ƒ∞lk d…ôf…ô istifad…ô edirsinizs…ô, master ≈üifr…ô yaradƒ±n.</p>
      <div class="grid">
        <div>
          <label>Master ≈üifr…ô</label>
          <input id="masterPassword" type="password" placeholder="G√ºcl√º master ≈üifr…ô" />
          <div class="hint" style="margin-top:6px">Master ≈üifr…ôni <u>unutmayƒ±n</u> ‚Äî b…ôrpa yoxdur.</div>
        </div>
        <div>
          <label>Rejim</label>
          <select id="isFirstTime">
            <option value="auto" selected>Avtomatik (m√∂vcuddursa a√ß)</option>
            <option value="yes">Yeni vault yarat</option>
            <option value="no">M√∂vcud vault-u a√ß</option>
          </select>
          <button id="unlockBtn" class="btn accent" style="margin-top:12px;width:100%">Daxil ol / Yarat</button>
        </div>
      </div>
    </div>

    <!-- APP CARD -->
    <div id="appCard" class="card pad hidden">
      <div class="toolbar">
        <div class="left metrics">
          <span id="entryCount" class="badge">0 qeyd</span>
          <span id="updatedAt" class="badge">‚Äî</span>
        </div>
        <div class="right">
          <input id="q" placeholder="Axtarƒ±≈ü (ba≈ülƒ±q, istifad…ô√ßi, URL, qeyd)" />
          <button id="addBtn" class="btn">Yeni</button>
          <button id="lockBtn" class="btn warn">Kilidl…ô</button>
        </div>
      </div>
      <div class="hr"></div>

      <table>
        <thead>
          <tr>
            <th>Ba≈ülƒ±q</th>
            <th>ƒ∞stifad…ô√ßi</th>
            <th>≈ûifr…ô</th>
            <th>URL</th>
            <th>Qeyd</th>
            <th class="right">∆èm…ôliyyatlar</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="hr"></div>
      <div class="toolbar">
        <div class="left">
          <button id="exportBtn" class="btn">≈ûifr…ôli ehtiyat n√ºsx…ô</button>
          <label class="btn" for="importFile" style="cursor:pointer">Ehtiyatƒ± daxil et</label>
          <input id="importFile" type="file" accept="application/json" class="hidden" />
          <button id="changeMasterBtn" class="btn">Master ≈üifr…ôni d…ôyi≈ü</button>
        </div>
        <div class="right hint">M…ôlumatlar localStorage-d…ô ≈üifr…ôli saxlanƒ±lƒ±r.</div>
      </div>

      <!-- Editor (inline modal-style section) -->
      <div id="editor" class="card pad hidden" style="margin-top:14px">
        <h2 id="editorTitle" style="margin:0 0 8px">Qeyd …ôlav…ô et</h2>
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label>Ba≈ülƒ±q</label>
            <input id="e_title" placeholder="m…ôs: Instagram" />
          </div>
          <div>
            <label>ƒ∞stifad…ô√ßi adƒ± / E‚Äëpo√ßt</label>
            <input id="e_username" placeholder="username" />
          </div>
          <div>
            <label>≈ûifr…ô</label>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="e_password" type="password" class="mono" />
              <button id="togglePwd" class="btn">G√∂st…ôr</button>
              <button id="copyPwd" class="btn">Kopyala</button>
            </div>
            <div class="hint" id="pwdStrength">G√ºcl√ºl√ºk: ‚Äî</div>
          </div>
          <div>
            <label>URL</label>
            <input id="e_url" placeholder="https://‚Ä¶" />
          </div>
        </div>
        <label style="margin-top:10px;display:block">Qeyd</label>
        <textarea id="e_notes" rows="3" placeholder="Opsional qeydl…ôr"></textarea>

        <div class="hr"></div>
        <div class="toolbar">
          <div class="left" style="align-items:flex-end">
            <div>
              <label>≈ûifr…ô generatoru</label>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <input id="genLen" type="number" min="8" max="64" value="16" style="width:120px" />
                <label style="display:inline-flex;gap:6px;align-items:center"><input id="genSymbols" type="checkbox" checked /> Simvollar</label>
                <button id="genBtn" class="btn">Generasiya</button>
              </div>
            </div>
          </div>
          <div class="right">
            <button id="saveBtn" class="btn accent">Yadda saxla</button>
            <button id="cancelBtn" class="btn">L…ôƒüv et</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
// ===== Theme handling =====
const themeToggle = document.getElementById('themeToggle');
function setTheme(dark){
  document.body.style.setProperty('--bg', dark? 'var(--bg-dark)' : 'var(--bg-light)');
  document.body.style.setProperty('--text', dark? 'var(--text-dark)' : 'var(--text-light)');
  document.body.style.setProperty('--panel', dark? 'var(--panel-dark)' : 'var(--panel-light)');
  document.body.style.setProperty('--muted', dark? 'var(--muted-dark)' : 'var(--muted-light)');
  document.body.style.setProperty('--border', dark? 'var(--border-dark)' : 'var(--border-light)');
  localStorage.setItem('theme', dark? 'dark':'light');
}
if(localStorage.getItem('theme')==='dark'){ themeToggle.checked=true; setTheme(true);} else { setTheme(false); }

themeToggle.addEventListener('change',()=> setTheme(themeToggle.checked));

// ===== Small helpers =====
const $ = sel => document.querySelector(sel);
const nowISO = () => new Date().toISOString();
const uid = () => crypto.getRandomValues(new Uint32Array(4)).join('-');
const toastEl = $('#toast');
function toast(msg){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=> toastEl.classList.remove('show'), 1600); }

// Base64 helpers
const b64 = {
  enc: buf => btoa(String.fromCharCode(...new Uint8Array(buf))),
  dec: str => Uint8Array.from(atob(str), c => c.charCodeAt(0)).buffer,
};

// ===== Crypto (Web Crypto API) =====
const ITER_DEFAULT = 250000; // PBKDF2 iterations
const SALT_BYTES = 16;
const IV_BYTES = 12; // AES-GCM 96-bit

async function deriveKey(password, saltB64, iterations){
  const enc = new TextEncoder();
  const pwKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  const key = await crypto.subtle.deriveKey({
      name:'PBKDF2', salt: b64.dec(saltB64), iterations: iterations, hash:'SHA-256'
    }, pwKey, { name:'AES-GCM', length:256 }, false, ['encrypt','decrypt']
  );
  return key;
}

async function encryptJSON(obj, key){
  const iv = crypto.getRandomValues(new Uint8Array(IV_BYTES));
  const data = new TextEncoder().encode(JSON.stringify(obj));
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data);
  return { ciphertext: b64.enc(ct), iv: b64.enc(iv) };
}

async function decryptJSON(ciphertextB64, ivB64, key){
  const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv: b64.dec(ivB64)}, key, b64.dec(ciphertextB64));
  const txt = new TextDecoder().decode(pt);
  return JSON.parse(txt);
}

// ===== Storage schema =====
// localStorage['vault'] = JSON.stringify({version:1, salt, iterations, iv, ciphertext, updatedAt})
function hasVault(){ try{ const v = JSON.parse(localStorage.getItem('vault')||'null'); return !!(v && v.ciphertext); }catch(e){ return false } }
function readVaultMeta(){ try{ return JSON.parse(localStorage.getItem('vault')||'null'); }catch(e){ return null } }
function writeVault(meta){ localStorage.setItem('vault', JSON.stringify(meta)); }
function clearVaultInMemory(){ state.vault = {version:1, entries:[]}; }

// ===== App state =====
const state = { key:null, vault:{version:1, entries:[]}, filter:'', editingId:null };

function esc(s){ return (s||'').replace(/[&<>"']/g, c=> ({'&':'&','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]) ); }

function renderList(){
  const tbody = $('#tbody'); tbody.innerHTML = '';
  const q = state.filter.toLowerCase().trim();
  const rows = state.vault.entries
    .filter(e => !q || [e.title,e.username,e.url,e.notes].some(x => (x||'').toLowerCase().includes(q)))
    .sort((a,b)=> (b.updatedAt||b.createdAt).localeCompare(a.updatedAt||a.createdAt));
  $('#entryCount').textContent = `${state.vault.entries.length} qeyd`;
  const meta = readVaultMeta();
  $('#updatedAt').textContent = meta?.updatedAt ? `Son yenil…ônm…ô: ${new Date(meta.updatedAt).toLocaleString()}` : '‚Äî';

  for(const e of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${esc(e.title)}</strong></td>
      <td class="mono">${esc(e.username||'')}</td>
      <td>
        <span class="mono muted">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
        <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap">
          <button class="btn" data-act="reveal" data-id="${e.id}">G√∂st…ôr</button>
          <button class="btn" data-act="copy" data-id="${e.id}">Kopyala</button>
        </div>
      </td>
      <td><a href="${esc(e.url||'#')}" target="_blank" rel="noopener">${esc(e.url||'')}</a></td>
      <td class="muted">${esc(e.notes||'')}</td>
      <td class="right">
        <button class="btn" data-act="edit" data-id="${e.id}">Redakt…ô</button>
        <button class="btn danger" data-act="del" data-id="${e.id}">Sil</button>
      </td>`;
    tbody.appendChild(tr);
  }
}

// ===== Vault ops =====
async function saveVaultToStorage(){
  if(!state.key) throw new Error('Key yoxdur');
  const meta0 = readVaultMeta() || {};
  const salt = meta0.salt || b64.enc(crypto.getRandomValues(new Uint8Array(SALT_BYTES)));
  const iterations = meta0.iterations || ITER_DEFAULT;
  const {ciphertext, iv} = await encryptJSON(state.vault, state.key);
  writeVault({ version:1, salt, iterations, iv, ciphertext, updatedAt: nowISO() });
}

async function loadVaultFromStorageWith(password){
  let meta = readVaultMeta();
  if(!meta){ // fresh vault
    meta = { version:1, salt: b64.enc(crypto.getRandomValues(new Uint8Array(SALT_BYTES))), iterations: ITER_DEFAULT };
    writeVault(meta);
  }
  const key = await deriveKey(password, meta.salt, meta.iterations||ITER_DEFAULT);
  if(!meta.ciphertext){ // init empty
    state.key = key; clearVaultInMemory(); await saveVaultToStorage(); return true;
  }
  try{ state.vault = await decryptJSON(meta.ciphertext, meta.iv, key); state.key = key; return true; }
  catch(err){ console.error(err); return false; }
}

async function changeMasterPasswordFlow(){
  const newPw = prompt('Yeni master ≈üifr…ôni daxil edin:'); if(!newPw) return;
  const newSalt = b64.enc(crypto.getRandomValues(new Uint8Array(SALT_BYTES)));
  const newKey = await deriveKey(newPw, newSalt, ITER_DEFAULT);
  const {ciphertext, iv} = await encryptJSON(state.vault, newKey);
  writeVault({version:1, salt:newSalt, iterations:ITER_DEFAULT, iv, ciphertext, updatedAt: nowISO()});
  toast('Master ≈üifr…ô d…ôyi≈üdirildi');
}

// ===== Editor helpers =====
function openEditor(entry){
  $('#editor').classList.remove('hidden');
  $('#editorTitle').textContent = entry && entry.id ? 'Qeydi redakt…ô et' : 'Qeyd …ôlav…ô et';
  $('#e_title').value = entry?.title || '';
  $('#e_username').value = entry?.username || '';
  $('#e_password').value = entry?.password || '';
  $('#e_url').value = entry?.url || '';
  $('#e_notes').value = entry?.notes || '';
  state.editingId = entry?.id || null;
  updatePwdStrength();
}
function closeEditor(){ $('#editor').classList.add('hidden'); state.editingId = null; }

function updatePwdStrength(){
  const s = ($('#e_password').value||'');
  let score = 0; if(s.length>=12) score++; if(/[a-z]/.test(s)&&/[A-Z]/.test(s)) score++; if(/\d/.test(s)) score++; if(/[^\w]/.test(s)) score++;
  const map = ['√áox z…ôif','Z…ôif','Orta','Yax≈üƒ±','G√ºcl√º'];
  $('#pwdStrength').textContent = 'G√ºcl√ºl√ºk: ' + map[score];
}

// ===== UI Actions =====
$('#unlockBtn').addEventListener('click', async()=>{
  const pw = $('#masterPassword').value; if(!pw){ toast('Master ≈üifr…ô daxil edin'); return; }
  const ok = await loadVaultFromStorageWith(pw);
  if(!ok){ toast('≈ûifr…ô s…ôhvdir v…ô ya vault a√ßƒ±la bilmir'); return; }
  $('#authCard').classList.add('hidden');
  $('#appCard').classList.remove('hidden');
  renderList();
});

$('#addBtn').addEventListener('click', ()=> openEditor(null));
$('#cancelBtn').addEventListener('click', ()=> closeEditor());
$('#lockBtn').addEventListener('click', ()=>{ state.key=null; clearVaultInMemory(); $('#tbody').innerHTML=''; $('#appCard').classList.add('hidden'); $('#authCard').classList.remove('hidden'); $('#masterPassword').value=''; toast('Vault kilidl…ôndi'); });
$('#q').addEventListener('input', (e)=>{ state.filter = e.target.value; renderList(); });

$('#saveBtn').addEventListener('click', async()=>{
  const entry = {
    id: state.editingId || uid(),
    title: $('#e_title').value.trim(),
    username: $('#e_username').value.trim(),
    password: $('#e_password').value,
    url: $('#e_url').value.trim(),
    notes: $('#e_notes').value,
    updatedAt: nowISO(),
  };
  if(!entry.title){ toast('Ba≈ülƒ±q t…ôl…ôb olunur'); return; }
  if(state.editingId){
    const i = state.vault.entries.findIndex(x=>x.id===state.editingId);
    if(i>=0) state.vault.entries[i] = {...state.vault.entries[i], ...entry};
  }else{ entry.createdAt = nowISO(); state.vault.entries.push(entry); }
  await saveVaultToStorage(); closeEditor(); renderList(); toast('Yadda saxlandƒ±');
});

$('#tbody').addEventListener('click', async(e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id; const act = btn.dataset.act; const entry = state.vault.entries.find(x=>x.id===id); if(!entry) return;
  if(act==='copy'){ try{ await navigator.clipboard.writeText(entry.password||''); toast('≈ûifr…ô kopyalandƒ±'); }catch{ toast('Kopyalama alƒ±nmadƒ±'); } }
  if(act==='reveal'){ alert(`≈ûifr…ô: \n\n${entry.password||''}`); }
  if(act==='edit'){ openEditor(entry); }
  if(act==='del'){
    if(confirm('Silm…ôk ist…ôdiyiniz…ô …ôminsiniz?')){ state.vault.entries = state.vault.entries.filter(x=>x.id!==id); await saveVaultToStorage(); renderList(); toast('Silindi'); }
  }
});

$('#exportBtn').addEventListener('click', ()=>{
  const meta = readVaultMeta(); if(!meta || !meta.ciphertext){ toast('Bo≈ü v…ô ya qeydsiz vault'); return; }
  const blob = new Blob([JSON.stringify(meta,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `vault-backup-${new Date().toISOString().replace(/[:.]/g,'-')}.json`; a.click(); URL.revokeObjectURL(a.href);
});

$('#importFile').addEventListener('change', async(e)=>{
  const file = e.target.files[0]; if(!file) return; const text = await file.text();
  try{ const meta = JSON.parse(text); if(!(meta && meta.ciphertext && meta.iv && meta.salt)) throw new Error('Yanlƒ±≈ü ehtiyat n√ºsx…ô faylƒ±'); writeVault(meta); alert('Ehtiyat daxil edildi. Yenid…ôn daxil olun.'); location.reload(); }
  catch(err){ alert('Y√ºkl…ôm…ô x…ôtasƒ±: '+err.message); }
});

$('#changeMasterBtn').addEventListener('click', ()=> changeMasterPasswordFlow());

// Password helpers
$('#togglePwd').addEventListener('click', ()=>{ const el = $('#e_password'); el.type = el.type==='password' ? 'text' : 'password'; });
$('#copyPwd').addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText($('#e_password').value||''); toast('≈ûifr…ô kopyalandƒ±'); }catch{ toast('Kopyalama alƒ±nmadƒ±'); } });
$('#e_password').addEventListener('input', updatePwdStrength);

// Generator
$('#genBtn').addEventListener('click', ()=>{
  const len = Math.max(8, Math.min(64, parseInt($('#genLen').value||'16')));
  const useSymbols = $('#genSymbols').checked;
  const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789' + (useSymbols?'!@#$%^&*()-_=+[]{};:,.<>?/':'');
  let out = '';
  const rnd = new Uint32Array(len); crypto.getRandomValues(rnd);
  for(let i=0;i<len;i++){ out += chars[rnd[i] % chars.length]; }
  $('#e_password').value = out; updatePwdStrength();
});
</script>
</body>
</html>
