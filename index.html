<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local Password Vault</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b;
      --ring:#3b82f6; --card:#0b1220; --border:#1f2937; --shadow:0 10px 25px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";background:linear-gradient(120deg,#0b1020,#0e152a 30%,#0a0f1e);color:var(--text)}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    .card{background:radial-gradient(1000px 400px at -10% -20%,rgba(59,130,246,.15),transparent),
                   radial-gradient(900px 400px at 120% -30%,rgba(34,197,94,.12),transparent),
                   var(--panel);
          border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow);}
    .pad{padding:18px}
    h1{font-size:26px;margin:0 0 8px}
    h2{font-size:18px;margin:12px 0}
    p{color:var(--muted)}
    label{display:block;font-size:14px;color:var(--muted);margin:10px 0 6px}
    input, textarea, select {width:100%;background:#0b1220;border:1px solid var(--border);color:var(--text);
      border-radius:10px;padding:10px 12px;outline:none}
    input:focus, textarea:focus, select:focus{border-color:var(--ring);box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    button{appearance:none;border:1px solid var(--border);background:#0d1326;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
    button:hover{filter:brightness(1.08)}
    .btn{display:inline-flex;align-items:center;gap:8px}
    .btn.primary{background:linear-gradient(180deg,#1f2937,#0d1326);border-color:#334155}
    .btn.accent{background:linear-gradient(180deg,#22c55e,#16a34a);border-color:#16a34a;color:#04120a;font-weight:600}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#b45309);color:#1a0b00;border-color:#b45309}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#b91c1c);color:#1a0b00;border-color:#b91c1c}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 240px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:12px 0 8px}
    .toolbar .left, .toolbar .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th{font-weight:600;color:#cbd5e1;font-size:13px;text-align:left;padding:0 10px}
    .table td{background:var(--card);border:1px solid var(--border);padding:10px;border-radius:10px}
    .table tr td:first-child{border-top-right-radius:0;border-bottom-right-radius:0}
    .table tr td:last-child{border-top-left-radius:0;border-bottom-left-radius:0}
    .tag{font-size:12px;color:#a3e635;background:#1a2e12;border:1px solid #334155;padding:2px 8px;border-radius:999px}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .hint{font-size:12px;color:#9ca3af}
    .hr{height:1px;background:linear-gradient(90deg,transparent,#2a364d,transparent);margin:14px 0}
    .hidden{display:none}
    .right{text-align:right}
    .flex{display:flex;gap:10px;align-items:center}
    .grow{flex:1}
    .center{display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Auth Card -->
    <div id="authCard" class="card pad">
      <h1>Local Password Vault</h1>
      <p>Şifrələriniz yalnız bu brauzerdə <strong>yerli</strong> saxlanılır və <strong>AES‑GCM</strong> ilə şifrələnir. İlk dəfə istifadə edirsinizsə, master şifrə yaradın.</p>
      <div id="setupBox" class="">
        <label>Master şifrə</label>
        <input id="masterPassword" type="password" placeholder="Güclü master şifrə" />
        <div class="row">
          <div class="col">
            <label>Yeni istifadəçi? (ilk quraşdırma) — <span class="hint">seçin</span></label>
            <select id="isFirstTime">
              <option value="auto" selected>Avtomatik aşkarla</option>
              <option value="yes">Bəli — yeni vault yarad</option>
              <option value="no">Xeyr — mövcud vault-u aç</option>
            </select>
          </div>
          <div class="col center">
            <button id="unlockBtn" class="btn accent">Daxil ol / Yarat</button>
          </div>
        </div>
        <p class="hint">Master şifrəni <u>unutmayın</u> — bərpa yoxdur. 2FA kodlarınızı ayrıca tətbiqdə saxlayın.</p>
      </div>
    </div>

    <!-- App Card -->
    <div id="appCard" class="card pad hidden">
      <div class="toolbar">
        <div class="left">
          <strong>Vault açıldı</strong>
          <span id="entryCount" class="tag">0 qeydlər</span>
          <span id="updatedAt" class="hint"></span>
        </div>
        <div class="right">
          <input id="q" placeholder="Axtarış (başlıq, istifadəçi, URL, qeyd)" />
          <button id="addBtn" class="btn primary">Yeni</button>
          <button id="lockBtn" class="btn warn">Kilidlə</button>
        </div>
      </div>
      <div class="hr"></div>

      <table class="table" id="list">
        <thead>
          <tr>
            <th>Başlıq</th>
            <th>İstifadəçi</th>
            <th>Şifrə</th>
            <th>URL</th>
            <th>Qeyd</th>
            <th class="right">Əməliyyatlar</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="hr"></div>
      <div class="toolbar">
        <div class="left">
          <button id="exportBtn" class="btn">Şifrəli ehtiyat nüsxə</button>
          <label class="btn" for="importFile" style="cursor:pointer">Ehtiyatı daxil et</label>
          <input id="importFile" type="file" accept="application/json" class="hidden" />
          <button id="changeMasterBtn" class="btn">Master şifrəni dəyiş</button>
        </div>
        <div class="right hint">Məlumatlar localStorage-də şifrəli saxlanılır.</div>
      </div>

      <!-- Editor Modal (inline simple) -->
      <div id="editor" class="card pad hidden" style="margin-top:14px">
        <h2 id="editorTitle">Qeyd əlavə et</h2>
        <div class="row">
          <div class="col">
            <label>Başlıq</label>
            <input id="e_title" placeholder="məs: Instagram" />
          </div>
          <div class="col">
            <label>İstifadəçi adı / E‑poçt</label>
            <input id="e_username" placeholder="username" />
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Şifrə</label>
            <div class="flex">
              <input id="e_password" type="password" class="grow mono" />
              <button id="togglePwd" class="btn">Göstər</button>
              <button id="copyPwd" class="btn">Kopyala</button>
            </div>
            <div class="hint" id="pwdStrength">Güclülük: —</div>
          </div>
          <div class="col">
            <label>URL</label>
            <input id="e_url" placeholder="https://…" />
          </div>
        </div>
        <label>Qeyd</label>
        <textarea id="e_notes" rows="3" placeholder="Opsional qeydlər"></textarea>

        <div class="row" style="align-items:flex-end">
          <div class="col">
            <label>Şifrə generatoru</label>
            <div class="flex">
              <input id="genLen" type="number" min="8" max="64" value="16" style="width:120px" />
              <label class="flex" style="gap:6px"><input id="genSymbols" type="checkbox" checked /> Simvollar</label>
              <button id="genBtn" class="btn">Generasiya</button>
            </div>
          </div>
          <div class="col right">
            <button id="saveBtn" class="btn accent">Yadda saxla</button>
            <button id="cancelBtn" class="btn">Ləğv et</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// ===== Utilities =====
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const b64 = {
  enc: buf => btoa(String.fromCharCode(...new Uint8Array(buf))),
  dec: str => Uint8Array.from(atob(str), c => c.charCodeAt(0)).buffer,
};
const nowISO = () => new Date().toISOString();
const uid = () => crypto.getRandomValues(new Uint32Array(4)).join('-');

// ===== Crypto (Web Crypto API) =====
const ITER_DEFAULT = 250000; // PBKDF2 iterations
const SALT_BYTES = 16;
const IV_BYTES = 12; // AES-GCM recommended 96-bit

async function deriveKey(password, saltB64, iterations){
  const enc = new TextEncoder();
  const pwKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  const key = await crypto.subtle.deriveKey({
      name:'PBKDF2', salt: b64.dec(saltB64), iterations: iterations, hash:'SHA-256'
    }, pwKey, { name:'AES-GCM', length:256 }, false, ['encrypt','decrypt']
  );
  return key;
}

async function encryptJSON(obj, key){
  const iv = crypto.getRandomValues(new Uint8Array(IV_BYTES));
  const data = new TextEncoder().encode(JSON.stringify(obj));
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data);
  return { ciphertext: b64.enc(ct), iv: b64.enc(iv) };
}

async function decryptJSON(ciphertextB64, ivB64, key){
  const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv: b64.dec(ivB64)}, key, b64.dec(ciphertextB64));
  const txt = new TextDecoder().decode(pt);
  return JSON.parse(txt);
}

// ===== Storage schema =====
// localStorage['vault'] = JSON.stringify({version:1, salt, iterations, iv, ciphertext, updatedAt})
function hasVault(){
  try{ const v = JSON.parse(localStorage.getItem('vault')||'null'); return !!(v && v.ciphertext); }catch(e){ return false }
}
function readVaultMeta(){
  try{ return JSON.parse(localStorage.getItem('vault')||'null'); }catch(e){ return null }
}
function writeVault(meta){ localStorage.setItem('vault', JSON.stringify(meta)); }
function clearVaultInMemory(){ state.vault = {version:1, entries:[]}; }

// ===== App state =====
const state = {
  key: null, // CryptoKey
  vault: {version:1, entries:[]},
  filter: '',
  editingId: null,
};

function renderList(){
  const tbody = $('#tbody');
  tbody.innerHTML = '';
  const q = state.filter.toLowerCase().trim();
  const rows = state.vault.entries
    .filter(e => !q || [e.title,e.username,e.url,e.notes].some(x => (x||'').toLowerCase().includes(q)))
    .sort((a,b)=> (b.updatedAt||b.createdAt).localeCompare(a.updatedAt||a.createdAt));
  $('#entryCount').textContent = `${state.vault.entries.length} qeydlər`;
  const meta = readVaultMeta();
  $('#updatedAt').textContent = meta?.updatedAt ? `• Son yenilənmə: ${new Date(meta.updatedAt).toLocaleString()}` : '';

  for(const e of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${esc(e.title)}</strong></td>
      <td class="mono">${esc(e.username||'')}</td>
      <td>
        <span class="mono muted">••••••••</span>
        <div class="flex" style="margin-top:6px">
          <button class="btn" data-act="reveal" data-id="${e.id}">Göstər</button>
          <button class="btn" data-act="copy" data-id="${e.id}">Kopyala</button>
        </div>
      </td>
      <td><a href="${esc(e.url||'#')}" target="_blank" rel="noopener">${esc(e.url||'')}</a></td>
      <td class="muted">${esc(e.notes||'')}</td>
      <td class="right">
        <button class="btn" data-act="edit" data-id="${e.id}">Redaktə</button>
        <button class="btn danger" data-act="del" data-id="${e.id}">Sil</button>
      </td>`;
    tbody.appendChild(tr);
  }
}

function esc(s){ return (s||'').replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]) ); }

// ===== Editor helpers =====
function openEditor(entry){
  $('#editor').classList.remove('hidden');
  $('#editorTitle').textContent = entry && entry.id ? 'Qeydi redaktə et' : 'Qeyd əlavə et';
  $('#e_title').value = entry?.title || '';
  $('#e_username').value = entry?.username || '';
  $('#e_password').value = entry?.password || '';
  $('#e_url').value = entry?.url || '';
  $('#e_notes').value = entry?.notes || '';
  state.editingId = entry?.id || null;
  updatePwdStrength();
}
function closeEditor(){ $('#editor').classList.add('hidden'); state.editingId = null; }

// ===== Vault ops =====
async function saveVaultToStorage(){
  if(!state.key) throw new Error('Key yoxdur');
  const {ciphertext, iv} = await encryptJSON(state.vault, state.key);
  const meta = readVaultMeta() || {};
  const salt = meta.salt || b64.enc(crypto.getRandomValues(new Uint8Array(SALT_BYTES)));
  const iterations = meta.iterations || ITER_DEFAULT;
  writeVault({ version:1, salt, iterations, iv, ciphertext, updatedAt: nowISO() });
}

async function loadVaultFromStorageWith(password){
  let meta = readVaultMeta();
  if(!meta){ // fresh vault
    meta = { version:1, salt: b64.enc(crypto.getRandomValues(new Uint8Array(SALT_BYTES))), iterations: ITER_DEFAULT };
    writeVault(meta);
  }
  const key = await deriveKey(password, meta.salt, meta.iterations||ITER_DEFAULT);
  // If no ciphertext yet -> initialize empty vault and persist
  if(!meta.ciphertext){
    state.key = key;
    clearVaultInMemory();
    await saveVaultToStorage();
    return true;
  }
  try{
    state.vault = await decryptJSON(meta.ciphertext, meta.iv, key);
    state.key = key;
    return true;
  }catch(err){
    console.error(err);
    return false;
  }
}

async function changeMasterPasswordFlow(){
  const newPw = prompt('Yeni master şifrəni daxil edin (boş buraxmayın):');
  if(!newPw) return;
  // create new salt and re-encrypt
  const newSalt = b64.enc(crypto.getRandomValues(new Uint8Array(SALT_BYTES)));
  const newKey = await deriveKey(newPw, newSalt, ITER_DEFAULT);
  const {ciphertext, iv} = await encryptJSON(state.vault, newKey);
  writeVault({version:1, salt:newSalt, iterations:ITER_DEFAULT, iv, ciphertext, updatedAt: nowISO()});
  alert('Master şifrə yeniləndi. Unutmayın!');
}

// ===== UI Actions =====
$('#unlockBtn').addEventListener('click', async()=>{
  const pw = $('#masterPassword').value;
  if(!pw){ alert('Master şifrə daxil edin.'); return; }
  const exists = hasVault();
  const mode = $('#isFirstTime').value;
  const openingNew = !exists || mode==='yes';
  if(openingNew && exists===false){ /* proceed */ }
  const ok = await loadVaultFromStorageWith(pw);
  if(!ok){ alert('Şifrə səhvdir və ya vault açıla bilmir.'); return; }
  // Show app
  $('#authCard').classList.add('hidden');
  $('#appCard').classList.remove('hidden');
  renderList();
});

$('#addBtn').addEventListener('click', ()=> openEditor(null));
$('#cancelBtn').addEventListener('click', ()=> closeEditor());
$('#lockBtn').addEventListener('click', ()=>{
  // best effort: wipe sensitive fields
  state.key = null; clearVaultInMemory(); $('#tbody').innerHTML='';
  $('#appCard').classList.add('hidden');
  $('#authCard').classList.remove('hidden');
  $('#masterPassword').value='';
});

$('#q').addEventListener('input', (e)=>{ state.filter = e.target.value; renderList(); });

$('#saveBtn').addEventListener('click', async()=>{
  const entry = {
    id: state.editingId || uid(),
    title: $('#e_title').value.trim(),
    username: $('#e_username').value.trim(),
    password: $('#e_password').value,
    url: $('#e_url').value.trim(),
    notes: $('#e_notes').value,
    updatedAt: nowISO(),
  };
  if(!entry.title){ alert('Başlıq tələb olunur.'); return; }
  if(state.editingId){
    const i = state.vault.entries.findIndex(x=>x.id===state.editingId);
    if(i>=0) state.vault.entries[i] = {...state.vault.entries[i], ...entry};
  }else{
    entry.createdAt = nowISO();
    state.vault.entries.push(entry);
  }
  await saveVaultToStorage();
  closeEditor(); renderList();
});

$('#tbody').addEventListener('click', async(e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id; const act = btn.dataset.act;
  const entry = state.vault.entries.find(x=>x.id===id);
  if(!entry) return;
  if(act==='copy'){
    try{ await navigator.clipboard.writeText(entry.password||''); alert('Şifrə kopyalandı.'); }catch{ alert('Kopyalama alınmadı.'); }
  }
  if(act==='reveal'){
    alert(`Şifrə: \n\n${entry.password||''}`);
  }
  if(act==='edit'){
    openEditor(entry);
  }
  if(act==='del'){
    if(confirm('Silmək istədiyinizə əminsiniz?')){
      state.vault.entries = state.vault.entries.filter(x=>x.id!==id);
      await saveVaultToStorage(); renderList();
    }
  }
});

$('#exportBtn').addEventListener('click', ()=>{
  const meta = readVaultMeta();
  if(!meta || !meta.ciphertext){ alert('Boş və ya qeydsiz vault.'); return; }
  const blob = new Blob([JSON.stringify(meta,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `vault-backup-${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
});

$('#importFile').addEventListener('change', async(e)=>{
  const file = e.target.files[0]; if(!file) return;
  const text = await file.text();
  try{
    const meta = JSON.parse(text);
    if(!(meta && meta.ciphertext && meta.iv && meta.salt)) throw new Error('Yanlış ehtiyat nüsxə faylı.');
    writeVault(meta);
    alert('Ehtiyat nüsxə daxil edildi. İndi master şifrə ilə yenidən daxil olun.');
    location.reload();
  }catch(err){ alert('Yükləmə xətası: '+err.message); }
});

$('#changeMasterBtn').addEventListener('click', ()=>{ changeMasterPasswordFlow(); });

// Password field helpers
$('#togglePwd').addEventListener('click', ()=>{
  const el = $('#e_password'); el.type = el.type==='password' ? 'text' : 'password';
});
$('#copyPwd').addEventListener('click', async()=>{
  try{ await navigator.clipboard.writeText($('#e_password').value||''); alert('Şifrə kopyalandı.'); }catch{ alert('Kopyalama alınmadı.'); }
});

function updatePwdStrength(){
  const s = ($('#e_password').value||'');
  let score = 0; if(s.length>=12) score++; if(/[a-z]/.test(s)&&/[A-Z]/.test(s)) score++; if(/\d/.test(s)) score++; if(/[^\w]/.test(s)) score++;
  const map = ['Çox zəif','Zəif','Orta','Yaxşı','Güclü'];
  $('#pwdStrength').textContent = 'Güclülük: ' + map[score];
}
$('#e_password').addEventListener('input', updatePwdStrength);

$('#genBtn').addEventListener('click', ()=>{
  const len = Math.max(8, Math.min(64, parseInt($('#genLen').value||'16')));
  const useSymbols = $('#genSymbols').checked;
  const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789' + (useSymbols?'!@#$%^&*()-_=+[]{};:,.<>?/':'');
  let out = '';
  const rnd = new Uint32Array(len); crypto.getRandomValues(rnd);
  for(let i=0;i<len;i++){ out += chars[rnd[i] % chars.length]; }
  $('#e_password').value = out; updatePwdStrength();
});

</script>
</body>
</html>
